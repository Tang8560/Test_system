
<!DOCTYPE html>
<html lang="en">
    <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b94bd2699a7baf9292dd9cf571f7fbb9";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
<head>
    <meta charset="utf-8">
    
    <meta name="referrer" content="same-origin" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="keywords" content="Django,Django教程,Django视频,Django实战,Vue,Django开发,Python,Python教程,Web开发, 运维, 自动化,博客," />
    <meta name="description" content="提供Python、Django、Vue、数据分析的原创中文精品教程和博客,分享技术知识,传播新闻视点,提倡开源精神,让更多开发者从中受益。">
    <meta name="author" content="刘江,liujiang,大江东流">

    <title>
    
    python 多线程threading - 刘江的python教程
    
</title>

    <link href="/static/css/bootstrap4.min.css" rel="stylesheet">
    <link href="https://cdn.bootcss.com/font-awesome/5.10.0-11/css/all.min.css" rel="stylesheet">

    <link rel="shortcut icon" href="/static/images/ico/favicon.ico">
    <link href="/static/css/main.css" rel="stylesheet">
    <link href="/static/css/vs.css" rel="stylesheet">

    

</head>

<body>

    <div class="container">
        
        <nav class="navbar fixed-top navbar-expand-lg navbar-light bg-light " id="top_nav" >


                    <a class="navbar-brand" href="/">刘江的博客教程</a>


                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#top_bar" aria-controls="top_bar" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="top_bar">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="/blog/">博客</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/course/python/">Python教程</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/course/django/">Django教程</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/course/data/">数据分析教程</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/video/" style="color: orangered">视频教程</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/follow/">公众号</a>
                        </li>
                    </ul>

                        
                          <!--通过在login后添加next参数，让用户登录后返回先前的页面-->
                            <a class="nav-link" href="https://api.weibo.com/oauth2/authorize?client_id=3191049160&response_type=code&redirect_uri=http://www.liujiangblog.com/login?next=/course/python/79">
                                <span class="text-success">登录</span>
                            </a>
                        

                </div>
            </nav>
    </div>

        
    <div class="container" style="margin-top:5rem;">
        <p>
        最新Django3.1大神之路视频！长达<strong style="color: red">77小时、17G、233节</strong> ，全方位无死角深入源码的专注教程！包含完整的模型层、数据迁移、
            类视图、异步视图、日志、认证权限和开发工具等更多文字教程未包含的内容。免费章节pan.baidu.com/s/1dqGWNwmBnLxhM7DnXiePIQ 提取码：ko4y
            。查看视频介绍<a href="/video/19/" target="_blank" style="color: red">点我</a>
        </p>

    </div>

    <div class="container">
        

    
    
    


      <div class="row">

        <!-- 左侧目录栏 -->
        <div class="col-md-3" >
          <div class="navbar-sider " id="sidebar">
            
                
                        
                            
                            <a href="/course/python/1" class="list-group-item"><b>Python教程</b></a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 1.5em" href="/course/python/3"
                               class="list-group-item">Python简介</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 1.5em" href="/course/python/4"
                               class="list-group-item">Python环境搭建</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/5"
                               class="list-group-item">pip的安装和使用</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/6"
                               class="list-group-item">virtualenv 虚拟环境</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/7"
                               class="list-group-item">代码编辑器</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/8"
                               class="list-group-item">帮助文档</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 1.5em" href="/course/python/9"
                               class="list-group-item">编译器与解释器</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 1.5em" href="/course/python/10"
                               class="list-group-item">“Hello World！”</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 1.5em" href="/course/python/11"
                               class="list-group-item">基础知识</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/12"
                               class="list-group-item">基础语法</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/13"
                               class="list-group-item">变量与常量</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/14"
                               class="list-group-item">运算符</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/15"
                               class="list-group-item">输入输出</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 1.5em" href="/course/python/16"
                               class="list-group-item">数据类型</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/17"
                               class="list-group-item">数字类型</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/18"
                               class="list-group-item">布尔类型</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/19"
                               class="list-group-item">列表</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/20"
                               class="list-group-item">元组</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/21"
                               class="list-group-item">字符串</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/22"
                               class="list-group-item">字典</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/23"
                               class="list-group-item">bytes</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/24"
                               class="list-group-item">集合set</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 1.5em" href="/course/python/25"
                               class="list-group-item">流程控制</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/26"
                               class="list-group-item">顺序执行</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/27"
                               class="list-group-item">条件判断</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/28"
                               class="list-group-item">循环控制</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 1.5em" href="/course/python/29"
                               class="list-group-item">函数</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/30"
                               class="list-group-item">函数基础</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/31"
                               class="list-group-item">参数类型</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/32"
                               class="list-group-item">变量作用域</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/33"
                               class="list-group-item">range()函数</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/34"
                               class="list-group-item">递归函数</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/35"
                               class="list-group-item">匿名函数</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/36"
                               class="list-group-item">推导式</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/37"
                               class="list-group-item">迭代器</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/38"
                               class="list-group-item">生成器</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/39"
                               class="list-group-item">装饰器</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 1.5em" href="/course/python/40"
                               class="list-group-item">内置函数</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 1.5em" href="/course/python/41"
                               class="list-group-item">文件读写</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 1.5em" href="/course/python/42"
                               class="list-group-item">面向对象编程</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/43"
                               class="list-group-item">类和实例</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/44"
                               class="list-group-item">封装、继承和多态</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/45"
                               class="list-group-item">成员保护和访问限制</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/46"
                               class="list-group-item">@property装饰器</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/47"
                               class="list-group-item">特殊成员和魔法方法</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/48"
                               class="list-group-item">reflect反射</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 1.5em" href="/course/python/49"
                               class="list-group-item">异常处理</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 1.5em" href="/course/python/50"
                               class="list-group-item">调试和测试</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 1.5em" href="/course/python/51"
                               class="list-group-item">模块与包</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 1.5em" href="/course/python/52"
                               class="list-group-item">常用标准库</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/53"
                               class="list-group-item">os</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/54"
                               class="list-group-item">sys</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/55"
                               class="list-group-item">subprocess</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/56"
                               class="list-group-item">random</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/57"
                               class="list-group-item">bisect</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/58"
                               class="list-group-item">hashlib</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/59"
                               class="list-group-item">queue</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/60"
                               class="list-group-item">fileinput</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/61"
                               class="list-group-item">shutil</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/62"
                               class="list-group-item">zipfile</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/63"
                               class="list-group-item">tarfile</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/64"
                               class="list-group-item">getpass</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/65"
                               class="list-group-item">json</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/66"
                               class="list-group-item">pickle</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/67"
                               class="list-group-item">shelve</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/68"
                               class="list-group-item">time</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/69"
                               class="list-group-item">datetime</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/70"
                               class="list-group-item">timeit</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/71"
                               class="list-group-item">logging</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 1.5em" href="/course/python/72"
                               class="list-group-item">正则表达式</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/73"
                               class="list-group-item">正则表达式语法</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/74"
                               class="list-group-item">re模块</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 1.5em" href="/course/python/75"
                               class="list-group-item">网络编程</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/76"
                               class="list-group-item">socket编程</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/77"
                               class="list-group-item">socketserver编程</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 1.5em" href="/course/python/78"
                               class="list-group-item">多线程与多进程</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/79"
                               class="list-group-item active">多线程threading</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/80"
                               class="list-group-item">生产者消费者模式</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/81"
                               class="list-group-item">线程池</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 3em" href="/course/python/82"
                               class="list-group-item">多进程multiprocess</a>
                            
                        
                
            
                
                        
                            
                            <a style="margin-left: 1.5em" href="/course/python/83"
                               class="list-group-item">协程与异步IO</a>
                            
                        
                
            
          </div>


        </div>
        <!-- 左侧目录栏 结束 -->



        <!-- 右侧正文栏 -->
        <div class="col-md-9">
            <!-- 教程正文主体部分 -->
            <h1>多线程threading</h1>
            <small>阅读:&nbsp;41436&nbsp;&nbsp;&nbsp;&nbsp;
                <a href="#comments">评论</a>：2
            </small>
            <hr/>
            <p>在Python3中，通过threading模块提供线程的功能。原来的thread模块已废弃。但是threading模块中有个Thread类（大写的T，类名），是模块中最主要的线程类，一定要分清楚了，千万不要搞混了。</p>
<p>threading模块提供了一些比较实用的方法或者属性，例如：</p>
<table>
<thead>
<tr>
<th>方法与属性</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>current_thread()</td>
<td>返回当前线程</td>
</tr>
<tr>
<td>active_count()</td>
<td>返回当前活跃的线程数，1个主线程+n个子线程</td>
</tr>
<tr>
<td>get_ident()</td>
<td>返回当前线程</td>
</tr>
<tr>
<td>enumerater()</td>
<td>返回当前活动 Thread 对象列表</td>
</tr>
<tr>
<td>main_thread()</td>
<td>返回主 Thread 对象</td>
</tr>
<tr>
<td>settrace(func)</td>
<td>为所有线程设置一个 trace 函数</td>
</tr>
<tr>
<td>setprofile(func)</td>
<td>为所有线程设置一个 profile 函数</td>
</tr>
<tr>
<td>stack_size([size])</td>
<td>返回新创建线程栈大小；或为后续创建的线程设定栈大小为 size</td>
</tr>
<tr>
<td>TIMEOUT_MAX</td>
<td>Lock.acquire(), RLock.acquire(), Condition.wait() 允许的最大超时时间</td>
</tr>
</tbody>
</table>
<p>threading模块包含下面的类：</p>
<ul>
<li>Thread：基本线程类</li>
<li>Lock：互斥锁</li>
<li>RLock：可重入锁，使单一进程再次获得已持有的锁(递归锁)</li>
<li>Condition：条件锁，使得一个线程等待另一个线程满足特定条件，比如改变状态或某个值。</li>
<li>Semaphore：信号锁。为线程间共享的有限资源提供一个”计数器”，如果没有可用资源则会被阻塞。</li>
<li>Event：事件锁，任意数量的线程等待某个事件的发生，在该事件发生后所有线程被激活</li>
<li>Timer：一种计时器</li>
<li>Barrier：Python3.2新增的“阻碍”类，必须达到指定数量的线程后才可以继续执行。</li>
</ul>
<h2>1. 多线程</h2>
<p>有两种方式来创建线程：一种是继承Thread类，并重写它的run()方法；另一种是在实例化<code>threading.Thread</code>对象的时候，将线程要执行的任务函数作为参数传入线程。</p>
<p>第一种方法：</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">threading</span>

<span class="k">class</span> <span class="nc">MyThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thread_name</span><span class="p">):</span>
        <span class="c1"># 注意：一定要显式的调用父类的初始化函数。</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MyThread</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">thread_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">正在运行中......&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">MyThread</span><span class="p">(</span><span class="s2">&quot;thread-&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>


<p>第二种方法：</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;thread &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; running....&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">show</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,))</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>


<p>对于Thread类，它的定义如下：</p>
<div class="codehilite"><pre><span></span>threading.Thread(self, group=None, target=None, name=None,
     args=(), kwargs=None, *, daemon=None)
</pre></div>


<ul>
<li>参数group是预留的，用于将来扩展；</li>
<li>参数target是一个可调用对象，在线程启动后执行；</li>
<li>参数name是线程的名字。默认值为“Thread-N“，N是一个数字。</li>
<li>参数args和kwargs分别表示调用target时的参数列表和关键字参数。</li>
</ul>
<p>Thread类定义了以下常用方法与属性：</p>
<table>
<thead>
<tr>
<th>方法与属性</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>start()</td>
<td>启动线程，等待CPU调度</td>
</tr>
<tr>
<td>run()</td>
<td>线程被cpu调度后自动执行的方法</td>
</tr>
<tr>
<td>getName()、setName()和name</td>
<td>用于获取和设置线程的名称。</td>
</tr>
<tr>
<td>setDaemon()</td>
<td>设置为后台线程或前台线程（默认是False，前台线程）。如果是后台线程，主线程执行过程中，后台线程也在进行，主线程执行完毕后，后台线程不论成功与否，均停止。如果是前台线程，主线程执行过程中，前台线程也在进行，主线程执行完毕后，等待前台线程执行完成后，程序才停止。</td>
</tr>
<tr>
<td>ident</td>
<td>获取线程的标识符。线程标识符是一个非零整数，只有在调用了start()方法之后该属性才有效，否则它只返回None。</td>
</tr>
<tr>
<td>is_alive()</td>
<td>判断线程是否是激活的（alive）。从调用start()方法启动线程，到run()方法执行完毕或遇到未处理异常而中断这段时间内，线程是激活的。</td>
</tr>
<tr>
<td>isDaemon()方法和daemon属性</td>
<td>是否为守护线程</td>
</tr>
<tr>
<td>join([timeout])</td>
<td>调用该方法将会使主调线程堵塞，直到被调用线程运行结束或超时。参数timeout是一个数值类型，表示超时时间，如果未提供该参数，那么主调线程将一直堵塞到被调线程结束。</td>
</tr>
</tbody>
</table>
<p>在多线程执行过程中，有一个特点要注意，那就是每个线程各执行各的任务，不等待其它的线程，自顾自的完成自己的任务，比如下面的例子：</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="k">def</span> <span class="nf">doWaiting</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;start waiting:&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;stop waiting&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">))</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">doWaiting</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="c1"># 确保线程t已经启动</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;start job&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;end job&#39;</span><span class="p">)</span>
</pre></div>


<p>执行结果是：</p>
<div class="codehilite"><pre><span></span>start waiting: 10:50:35
start job
end job
stop waiting 10:50:38
</pre></div>


<p>Python默认会等待最后一个线程执行完毕后才退出。上面例子中，主线程没有等待子线程t执行完毕，而是啥都不管，继续往下执行它自己的代码，执行完毕后也没有结束整个程序，而是等待子线程t执行完毕，整个程序才结束。</p>
<p>有时候我们希望主线程等等子线程，不要“埋头往前跑”。那要怎么办？使用join()方法！如下所示：</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="k">def</span> <span class="nf">doWaiting</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;start waiting:&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;stop waiting&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">))</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">doWaiting</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="c1"># 确保线程t已经启动</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;start join&#39;</span><span class="p">)</span>
<span class="c1"># 将一直堵塞，直到t运行结束。</span>
<span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;end join&#39;</span><span class="p">)</span>
</pre></div>


<p>执行结果：</p>
<div class="codehilite"><pre><span></span>start waiting: 10:54:03
start join
stop waiting 10:54:06
end join
</pre></div>


<p>我们还可以使用<code>setDaemon(True)</code>把所有的子线程都变成主线程的守护线程，当主线程结束后，守护子线程也会随之结束，整个程序也跟着退出。</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="s2">&quot;开始工作&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>       <span class="c1"># 子线程停2s</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;子线程工作完毕&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run</span><span class="p">,)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>   <span class="c1"># 把子线程设置为守护线程，必须在start()之前设置</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>     <span class="c1"># 主线程停1秒</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;主线程结束了！&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">active_count</span><span class="p">())</span>  <span class="c1"># 输出活跃的线程数</span>
</pre></div>


<p>执行结果：</p>
<div class="codehilite"><pre><span></span>Thread-1 开始工作
Thread-2 开始工作
Thread-3 开始工作
主线程结束了！
4
</pre></div>


<h2>2. 自定义线程类</h2>
<p>对于threading模块中的Thread类，本质上是执行了它的run方法。因此可以自定义线程类，让它继承Thread类，然后重写run方法。</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">threading</span>

<span class="k">class</span> <span class="nc">MyThreading</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MyThreading</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">my_func</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    你可以把任何你想让线程做的事定义在这里</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="n">obj</span> <span class="o">=</span> <span class="n">MyThreading</span><span class="p">(</span><span class="n">my_func</span><span class="p">,</span> <span class="mi">123</span><span class="p">)</span>
<span class="n">obj</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>


<h2>3.线程锁</h2>
<p>由于线程之间的任务执行是CPU进行随机调度的，并且每个线程可能只执行了n条指令之后就被切换到别的线程了。当多个线程同时操作一个对象，如果没有很好地保护该对象，会造成程序结果的不可预期，这被称为“线程不安全”。为了保证数据安全，我们设计了线程锁，即同一时刻只允许一个线程操作该数据。线程锁用于锁定资源，可以同时使用多个锁，当你需要独占某一资源时，任何一个锁都可以锁这个资源，就好比你用不同的锁都可以把相同的一个箱子锁住是一个道理。</p>
<p>我们先看一下没有锁的情况下，脏数据是如何产生的。</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">number</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">plus</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">number</span>       <span class="c1"># global声明此处的number是外面的全局变量number</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>    <span class="c1"># 进行一个大数级别的循环加一运算</span>
        <span class="n">number</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;子线程</span><span class="si">%s</span><span class="s2">运算结束后，number = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="n">number</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>      <span class="c1"># 用2个子线程，就可以观察到脏数据</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">plus</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>


<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>       <span class="c1"># 等待2秒，确保2个子线程都已经结束运算。</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;主线程执行完毕后，number = &quot;</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
</pre></div>


<p>执行结果（每次数值可能都不一样）：</p>
<div class="codehilite"><pre><span></span>子线程Thread-2运算结束后，number = 1144974
子线程Thread-1运算结束后，number = 1181608
主线程执行完毕后，number =  1181608
</pre></div>


<p>结果并不等于2,000,000，可以很明显地看出脏数据的情况。这是因为两个线程在运行过程中，CPU随机调度，你算一会我算一会，在没有对number进行保护的情况下，就发生了数据错误。如果想获得正确结果，可以使用join()方法，让多线程变成顺序执行，如下修改代码片段：</p>
<div class="codehilite"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>     
    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">plus</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>        <span class="c1"># 添加这一行就让两个子线程变成了顺序执行</span>
</pre></div>


<p>上面为了防止脏数据而使用join()的方法，其实是让多线程变成了单线程，属于因噎废食的做法，正确的做法是使用线程锁。Python在threading模块中定义了几种线程锁类，分别是：</p>
<ul>
<li>Lock 互斥锁</li>
<li>RLock 可重入锁</li>
<li>Semaphore 信号</li>
<li>Event 事件</li>
<li>Condition 条件</li>
<li>Barrier “阻碍”</li>
</ul>
<h3>3.1 互斥锁Lock</h3>
<p>互斥锁是一种独占锁，同一时刻只有一个线程可以访问共享的数据。使用很简单，初始化锁对象，然后将锁当做参数传递给任务函数，在任务中加锁，使用后释放锁。</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">number</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">plus</span><span class="p">(</span><span class="n">lk</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">number</span>       <span class="c1"># global声明此处的number是外面的全局变量number</span>
    <span class="n">lk</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>        <span class="c1"># 开始加锁</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>    <span class="c1"># 进行一个大数级别的循环加一运算</span>
        <span class="n">number</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;子线程</span><span class="si">%s</span><span class="s2">运算结束后，number = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">(),</span> <span class="n">number</span><span class="p">))</span>
    <span class="n">lk</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>        <span class="c1"># 释放锁，让别的线程也可以访问number</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>      <span class="c1"># 用2个子线程，就可以观察到脏数据</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">plus</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">lock</span><span class="p">,))</span> <span class="c1"># 需要把锁当做参数传递给plus函数</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>       <span class="c1"># 等待2秒，确保2个子线程都已经结束运算。</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;主线程执行完毕后，number = &quot;</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
</pre></div>


<p>RLock的使用方法和Lock一模一样，只不过它支持重入锁。该锁对象内部维护着一个Lock和一个counter对象。counter对象记录了acquire的次数，使得资源可以被多次require。最后，当所有RLock被release后，其他线程才能获取资源。在同一个线程中，<code>RLock.acquire()</code>可以被多次调用，利用该特性，可以解决部分死锁问题。</p>
<h3>3.2 信号Semaphore</h3>
<p>类名：BoundedSemaphore。这种锁允许一定数量的线程同时更改数据，它不是互斥锁。比如地铁安检，排队人很多，工作人员只允许一定数量的人进入安检区，其它的人继续排队。</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">se</span><span class="p">):</span>
    <span class="n">se</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;run the thread: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">se</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="c1"># 设置允许5个线程同时运行</span>
<span class="n">semaphore</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">BoundedSemaphore</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">semaphore</span><span class="p">))</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>


<p>运行后，可以看到5个一批的线程被放行。</p>
<h3>3.3 事件Event</h3>
<p>类名：Event</p>
<p>事件线程锁的运行机制：全局定义了一个Flag，如果Flag的值为False，那么当程序执行wait()方法时就会阻塞，如果Flag值为True，线程不再阻塞。这种锁，类似交通红绿灯（默认是红灯），它属于在红灯的时候一次性阻挡所有线程，在绿灯的时候，<strong>一次性放行所有</strong>排队中的线程。</p>
<p>事件主要提供了四个方法set()、wait()、clear()和is_set()。</p>
<p>调用clear()方法会将事件的Flag设置为False。</p>
<p>调用set()方法会将Flag设置为True。</p>
<p>调用wait()方法将等待“红绿灯”信号。</p>
<p>is_set():判断当前是否"绿灯放行"状态</p>
<p>下面是一个模拟红绿灯，然后汽车通行的例子：</p>
<div class="codehilite"><pre><span></span><span class="c1">#利用Event类模拟红绿灯</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">lighter</span><span class="p">():</span>
    <span class="n">green_time</span> <span class="o">=</span> <span class="mi">5</span>       <span class="c1"># 绿灯时间</span>
    <span class="n">red_time</span> <span class="o">=</span> <span class="mi">5</span>         <span class="c1"># 红灯时间</span>
    <span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>          <span class="c1"># 初始设为绿灯</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\33</span><span class="s2">[32;0m 绿灯亮...</span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">green_time</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\33</span><span class="s2">[31;0m 红灯亮...</span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">red_time</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>      <span class="c1"># 判断当前是否&quot;放行&quot;状态</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;一辆[</span><span class="si">%s</span><span class="s2">] 呼啸开过...&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;一辆[</span><span class="si">%s</span><span class="s2">]开来，看到红灯，无奈的停下了...&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">] 看到绿灯亮了，瞬间飞起.....&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">light</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">lighter</span><span class="p">,)</span>
    <span class="n">light</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;奔驰&#39;</span><span class="p">,</span> <span class="s1">&#39;宝马&#39;</span><span class="p">,</span> <span class="s1">&#39;奥迪&#39;</span><span class="p">]:</span>
        <span class="n">car</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">name</span><span class="p">,))</span>
        <span class="n">car</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>


<p>运行结果：</p>
<div class="codehilite"><pre><span></span>绿灯亮...
一辆[奔驰] 呼啸开过...
一辆[宝马] 呼啸开过...
一辆[奥迪] 呼啸开过...
一辆[奥迪] 呼啸开过...
......
 红灯亮...
一辆[宝马]开来，看到红灯，无奈的停下了...
一辆[奥迪]开来，看到红灯，无奈的停下了...
一辆[奔驰]开来，看到红灯，无奈的停下了...
绿灯亮...
[奥迪] 看到绿灯亮了，瞬间飞起.....
一辆[奥迪] 呼啸开过...
[奔驰] 看到绿灯亮了，瞬间飞起.....
一辆[奔驰] 呼啸开过...
[宝马] 看到绿灯亮了，瞬间飞起.....
一辆[宝马] 呼啸开过...
一辆[奥迪] 呼啸开过...
......
</pre></div>


<h3>3.3 条件Condition</h3>
<p>类名：Condition</p>
<p>Condition称作条件锁，依然是通过acquire()/release()加锁解锁。 </p>
<p>wait([timeout])方法将使线程进入Condition的等待池等待通知，并释放锁。使用前线程必须已获得锁定，否则将抛出异常。 </p>
<p>notify()方法将从等待池挑选一个线程并通知，收到通知的线程将自动调用acquire()尝试获得锁定（进入锁定池），其他线程仍然在等待池中。调用这个方法不会释放锁定。使用前线程必须已获得锁定，否则将抛出异常。 </p>
<p>notifyAll()方法将通知等待池中所有的线程，这些线程都将进入锁定池尝试获得锁定。调用这个方法不会释放锁定。使用前线程必须已获得锁定，否则将抛出异常。</p>
<p>下面的例子，有助于你理解Condition的使用方法：</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">con</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Condition</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Foo</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">action</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">num</span>
        <span class="n">con</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">开始执行...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;add&quot;</span><span class="p">:</span>
                <span class="n">num</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;reduce&#39;</span><span class="p">:</span>
                <span class="n">num</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;num当前为：&quot;</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">or</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;暂停执行</span><span class="si">%s</span><span class="s2">！&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">con</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>
                <span class="n">con</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">开始执行...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">con</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">(</span><span class="s2">&quot;线程A&quot;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">(</span><span class="s2">&quot;线程B&quot;</span><span class="p">,</span> <span class="s1">&#39;reduce&#39;</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">b</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>


<p>如果不强制停止，程序会一直执行下去，并循环下面的结果：</p>
<div class="codehilite"><pre><span></span>线程A开始执行...
num当前为： 1
num当前为： 2
num当前为： 3
num当前为： 4
num当前为： 5
暂停执行线程A！
线程B开始执行...
num当前为： 4
num当前为： 3
num当前为： 2
num当前为： 1
num当前为： 0
暂停执行线程B！
线程A开始执行...
num当前为： 1
num当前为： 2
num当前为： 3
num当前为： 4
num当前为： 5
暂停执行线程A！
线程B开始执行...
</pre></div>


<h2>4. 定时器Timer</h2>
<p>定时器Timer类是threading模块中的一个小工具，用于指定n秒后执行某操作。一个简单但很实用的东西。</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Timer</span>

<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello, world&quot;</span><span class="p">)</span>

<span class="c1"># 表示1秒后执行hello函数</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">hello</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>


<h2>5. 通过with语句使用线程锁</h2>
<p>所有的线程锁都有一个加锁和释放锁的动作，非常类似文件的打开和关闭。在加锁后，如果线程执行过程中出现异常或者错误，没有正常的释放锁，那么其他的线程会造到致命性的影响。通过with上下文管理器，可以确保锁被正常释放。其格式如下：</p>
<div class="codehilite"><pre><span></span>with some_lock:
    # 执行任务...
</pre></div>


<p>这相当于：</p>
<div class="codehilite"><pre><span></span>some_lock.acquire()
try:
    # 执行任务..
finally:
    some_lock.release()
</pre></div>


<h2>6. 全局解释器锁（GIL）</h2>
<p>既然介绍了多线程和线程锁，那就不得不提及Python的GIL问题。</p>
<p>在大多数环境中，单核CPU情况下，本质上某一时刻只能有一个线程被执行，多核CPU时则 可以支持多个线程同时执行。但是在Python中，无论CPU有多少核，同时只能执行一个线程。这是由于GIL的存在导致的。</p>
<p>GIL的全称是<code>Global Interpreter Lock</code>(全局解释器锁)，是Python设计之初为了数据安全所做的决定。Python中的某个线程想要执行，必须先拿到GIL。可以把GIL看作是执行任务的“通行证”，并且在一个Python进程中，GIL只有一个。拿不到通行证的线程，就不允许进入CPU执行。GIL只在CPython解释器中才有，因为CPython调用的是c语言的原生线程，不能直接操作cpu，只能利用GIL保证同一时间只能有一个线程拿到数据。在PyPy和JPython中没有GIL。</p>
<p><strong>Python多线程的工作流程：</strong></p>
<ol>
<li>拿到公共数据</li>
<li>申请GIL</li>
<li>Python解释器调用操作系统原生线程</li>
<li>cpu执行运算</li>
<li>当该线程执行一段时间消耗完，无论任务是否已经执行完毕，都会释放GIL</li>
<li>下一个被CPU调度的线程重复上面的过程</li>
</ol>
<p><strong>Python针对不同类型的任务，多线程执行效率是不同的：</strong></p>
<p>对于CPU密集型任务(各种循环处理、计算等等)，由于计算工作多，ticks计数很快就会达到阈值，然后触发GIL的释放与再竞争（多个线程来回切换是需要消耗资源的），所以Python下的多线程对CPU密集型任务并不友好。</p>
<p>IO密集型任务(文件处理、网络通信等涉及数据读写的操作)，多线程能够有效提升效率(单线程下有IO操作会进行IO等待，造成不必要的时间浪费，而开启多线程能在线程A等待时，自动切换到线程B，可以不浪费CPU的资源，从而能提升程序执行效率)。所以Python的多线程对IO密集型任务比较友好。</p>
<p><strong>为什么不能去掉GIL？</strong></p>
<p>首先，在早期的Python解释器依赖较多的全局状态，传承下来，使得想要移除当今的GIL变得更加困难。其次，对于程序员而言，仅仅是理解GIL的实现就需要对操作系统设计、多线程编程、C语言、解释器设计和CPython解释器的实现有着非常彻底的理解，更不用说对它进行修改删除了。总之，整体技术难度大，会对当前内部框架产生根本性的影响，牵一发而动全身。</p>
<p>在1999年，针对Python1.5，一个叫做“freethreading”的补丁已经尝试移除GIL，用细粒度的锁来代替。然而，GIL的移除给单线程程序的执行速度带来了一定的负面影响。当用单线程执行时，速度大约降低了40%。虽然使用两个线程时在速度上得到了提高，但这个提高并没有随着核数的增加而线性增长。因此这个补丁没有被采纳。</p>
<p>虽然，在Python的不同解释器实现中，如PyPy就移除了GIL，其执行速度更快（不单单是去除GIL的原因）。但是，我们通常使用的CPython解释器版本占有着统治地位的使用量，所以，你懂的。</p>
<p><strong>在实际使用中的建议：</strong></p>
<p>Python中想要充分利用多核CPU，就用多进程。因为每个进程有各自独立的GIL，互不干扰，这样就可以真正意义上的并行执行。在Python中，多进程的执行效率优于多线程(仅仅针对多核CPU而言)。同时建议在IO密集型任务中使用多线程，在计算密集型任务中使用多进程。另外，深入研究Python的协程机制，你会有惊喜的。</p>
<p>更多的详细介绍和说明请参考下面的文献：
英文原版：<a href="https://jeffknupp.com/blog/2012/03/31/pythons-hardest-problem/">Python's Hardest Problem</a>
中文翻译：<a href="http://www.oschina.net/translate/pythons-hardest-problem">Python 最难的问题</a></p>
            <hr />



            <!-- 教程导航条 -->
            <div >
                
                    <a href="/course/python/78">
                        <i class="fa fa-arrow-left"></i>&nbsp;多线程与多进程</a>
                

                
                    <a class="float-right" href="/course/python/80">
                        生产者消费者模式&nbsp;<i class="fa fa-arrow-right"></i></a>
                
            </div>
            <!-- 教程导航条结束 -->
            <hr />




            <!-- 评论区-->
            <!-- 显示评论条数-->
            <h4>评论总数：  2</h4>
            <hr />

            <!-- 评论表单区-->
            <div>
                
                    <a class='text-danger' href="https://api.weibo.com/oauth2/authorize?client_id=3191049160&response_type=code&redirect_uri=http://www.liujiangblog.com/login?next=/course/python/79">点击登录后方可评论</a>
                
            </div>
            <!-- 评论表单区结束-->

            <hr />

            <!-- 评论显示区-->
            <div id="comments">
                
                    <div class="comment " style="margin-left: 0em">
                        <div class="row">
                            <div >
                                <img src="https://tvax3.sinaimg.cn/crop.0.0.132.132.50/007CBOFTly4fzsv8b4efpj303o03o0sk.jpg?KID=imgbed,tva&amp;Expires=1572782252&amp;ssig=dMFfNpRKqR" alt="user_image">
                            </div>

                            <div class="comment-content  col-md-10" >

                                <p>博主你好，Condition 示例挺不错，但是 a,b 线程开启后就进入了 &quot;运行 -&gt; wait for notify -&gt; 运行 -&gt; wait for notify &quot; 死循环，最后一句 con.release() 完全失效，相当于两个僵尸线程了，请问怎样才能退出呢！期待回复，谢谢。</p>
                                <br />
                                <div class="comment_footer small mute">
                                    
                                        <span>By&nbsp;&nbsp;
                                            
                                                西柚外卖小哥
                                            
                                        </span>&nbsp;&nbsp;&nbsp;On&nbsp;&nbsp;
                                    
                                    <em>2019年11月3日 17:02</em>&nbsp;&nbsp;
                                    <a class="text-info" href="/reply/1690">回复</a>
                                </div>
                                <br />
                            </div>
                        </div>
                    </div>
                
                    <div class="comment " style="margin-left: 0em">
                        <div class="row">
                            <div >
                                <img src="http://tvax4.sinaimg.cn/default/images/default_avatar_male_50.gif" alt="user_image">
                            </div>

                            <div class="comment-content  col-md-10" >

                                <p>写的挺好</p>
                                <br />
                                <div class="comment_footer small mute">
                                    
                                        <span>By&nbsp;&nbsp;
                                            
                                                万里长江3272007811
                                            
                                        </span>&nbsp;&nbsp;&nbsp;On&nbsp;&nbsp;
                                    
                                    <em>2018年8月30日 08:28</em>&nbsp;&nbsp;
                                    <a class="text-info" href="/reply/713">回复</a>
                                </div>
                                <br />
                            </div>
                        </div>
                    </div>
                
            <!-- 评论显示区结束-->

            <!-- 评论区结束-->

        </div>
        <!-- 右侧正文栏结束 -->

      </div>
    </div>

    </div>



    
    <div class="container-fluid ">
        <nav class="navbar navbar-expand-md navbar-light bg-light" id="foot_nav">

            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#foot_bar" aria-controls="foot_bar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="foot_bar">

                <ul class="navbar-nav">
                    <li class="nav-item mr-1">
                        <a class="nav-link" href="#" >Copyright &copy; 2021.刘江的官方网站</a>
                    </li>
                    <li class="nav-item mr-1">
                        <a class="nav-link" target="_blank" href="https://beian.miit.gov.cn/#/Integrated/index">京ICP备17055098号</a>
                    </li>
                    <li class="nav-item mr-1">
                        <a class="nav-link" target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010602120033">
                            京公网安备11010102002019号
                        </a>
                    </li>
                    <li class="nav-item mr-1">
                        <a class="nav-link" href="/">返回首页</a>
                    </li>
                    <li class="nav-item mr-1">
                        <a class="nav-link" href="/about/">关于博主</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/contact/">联系方式</a>
                    </li>

                </ul>
            </div>
        </nav>
    </div>

    
    <div id="back-to-top" >
        <span class="fa fa-angle-double-up"></span>
    </div>


    <script src="/static/js/jquery.js"></script>
    <script src="/static/js/bootstrap4.min.js"></script>


    <script>


        //为外站视频添加访问量
        function count_visiting(video_id){
            var to_url = "/video/" + video_id;
            jQuery.get(to_url);
        }

        <!-- 导航条对应条目active -->
        $(document).ready(function () {

            $('#top_bar').find('a').each(function () {
                if (this.href === document.location.href || document.location.href.search(this.href) >= 0) {
                    $(this).parent().addClass('active');
                }
            });

            $('table').addClass('table table-bordered table-hover');

            $('img').addClass('img-responsive');

            $('#back-to-top').click(function () {
                window.scrollTo(0,0);
            });

        });

    

        $('button.navbar-toggle').click(function () {
            $('#my-navbar').css("background","#337ab7")
        });
        
    </script>

    
    <!--让左边目录栏跟随滚动  2019-9-25取消此功能-->





























</body>
</html>